<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>时间对齐调试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .debug-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .time-grid {
            position: relative;
            border: 1px solid #ddd;
            background: #fafafa;
            margin: 10px 0;
            width: 300px;
        }
        .time-slot {
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            padding-left: 10px;
            font-size: 12px;
            color: #666;
            position: relative;
        }
        .desktop .time-slot {
            height: 48px;
        }
        .mobile .time-slot {
            height: 40px;
        }
        .event-test {
            position: absolute;
            background: rgba(59, 130, 246, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            left: 80px;
            width: 180px;
            border: 1px solid #1d4ed8;
            z-index: 10;
        }
        .ruler {
            position: absolute;
            left: 0;
            right: 0;
            height: 1px;
            background: red;
            z-index: 20;
        }
        .ruler::before {
            content: attr(data-time);
            position: absolute;
            right: 5px;
            top: -10px;
            font-size: 10px;
            color: red;
            background: white;
            padding: 0 2px;
        }
        .info {
            background: #e0f2fe;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
        }
        .calculation {
            background: #f3e8ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 11px;
        }
        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>时间对齐精确调试</h1>
    
    <div class="debug-container">
        <h2>桌面端测试 (48px/小时 = 0.8px/分钟)</h2>
        <div class="info">
            BASE_START_MIN = 420 (7:00 AM)<br>
            时间槽高度: 48px<br>
            PIXEL_PER_MIN = 0.8
        </div>
        <div class="time-grid desktop" id="desktopGrid">
            <!-- 时间槽和事件将通过JavaScript生成 -->
        </div>
    </div>
    
    <div class="debug-container">
        <h2>移动端测试 (40px/小时 ≈ 0.667px/分钟)</h2>
        <div class="info">
            BASE_START_MIN = 420 (7:00 AM)<br>
            时间槽高度: 40px<br>
            PIXEL_PER_MIN = 40/60 ≈ 0.667
        </div>
        <div class="time-grid mobile" id="mobileGrid">
            <!-- 时间槽和事件将通过JavaScript生成 -->
        </div>
    </div>
    
    <div class="debug-container">
        <h2>对齐验证结果</h2>
        <div id="results"></div>
    </div>
    
    <script>
        const BASE_START_MIN = 7 * 60; // 7:00 = 420分钟
        const END_MIN = 12 * 60; // 12:00 = 720分钟
        
        function pad(n) { return n < 10 ? '0' + n : '' + n; }
        function fmtHM(minutesOfDay) { 
            const h = Math.floor(minutesOfDay / 60); 
            const m = minutesOfDay % 60; 
            return `${pad(h)}:${pad(m)}`; 
        }
        
        function createDebugGrid(containerId, pixelPerMin, slotHeight, isMobile = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            const results = [];
            
            // 创建时间槽
            let cumulativeHeight = 0;
            for (let min = BASE_START_MIN; min < END_MIN; min += 60) {
                const slot = document.createElement('div');
                slot.className = 'time-slot';
                slot.textContent = fmtHM(min);
                slot.style.height = slotHeight + 'px';
                slot.style.top = cumulativeHeight + 'px';
                container.appendChild(slot);
                
                // 添加时间标尺
                const ruler = document.createElement('div');
                ruler.className = 'ruler';
                ruler.style.top = cumulativeHeight + 'px';
                ruler.setAttribute('data-time', fmtHM(min));
                container.appendChild(ruler);
                
                cumulativeHeight += slotHeight;
            }
            
            // 设置容器高度
            const totalHours = (END_MIN - BASE_START_MIN) / 60;
            container.style.height = (totalHours * slotHeight) + 'px';
            
            // 测试事件数据
            const testEvents = [
                { time: '8:00', min: 8 * 60, label: '8:00整点' },
                { time: '8:30', min: 8.5 * 60, label: '8:30半点' },
                { time: '9:00', min: 9 * 60, label: '9:00整点' },
                { time: '10:15', min: 10.25 * 60, label: '10:15刻点' }
            ];
            
            testEvents.forEach((event, index) => {
                const eventEl = document.createElement('div');
                eventEl.className = 'event-test';
                eventEl.textContent = event.label;
                
                const calculatedTop = (event.min - BASE_START_MIN) * pixelPerMin;
                const expectedSlotIndex = (event.min - BASE_START_MIN) / 60;
                const expectedTop = expectedSlotIndex * slotHeight;
                
                eventEl.style.top = calculatedTop + 'px';
                eventEl.style.height = '20px';
                eventEl.style.background = index % 2 === 0 ? '#3b82f6' : '#ef4444';
                
                container.appendChild(eventEl);
                
                // 记录结果
                const isAligned = Math.abs(calculatedTop - expectedTop) < 1;
                results.push({
                    time: event.time,
                    calculated: calculatedTop,
                    expected: expectedTop,
                    difference: calculatedTop - expectedTop,
                    aligned: isAligned,
                    type: isMobile ? 'mobile' : 'desktop'
                });
            });
            
            return results;
        }
        
        // 创建测试
        const desktopResults = createDebugGrid('desktopGrid', 0.8, 48, false);
        const mobileResults = createDebugGrid('mobileGrid', 40/60, 40, true);
        
        // 显示结果
        function displayResults() {
            const resultsContainer = document.getElementById('results');
            let html = '<h3>对齐检测详细结果</h3>';
            
            const allResults = [...desktopResults, ...mobileResults];
            
            allResults.forEach(result => {
                const statusClass = result.aligned ? 'info' : 'error';
                const statusText = result.aligned ? '✅ 对齐' : '❌ 不对齐';
                
                html += `
                    <div class="${statusClass}">
                        <strong>${result.type === 'mobile' ? '移动端' : '桌面端'} - ${result.time}</strong><br>
                        计算位置: ${result.calculated.toFixed(2)}px<br>
                        期望位置: ${result.expected.toFixed(2)}px<br>
                        差异: ${result.difference.toFixed(2)}px<br>
                        状态: ${statusText}
                    </div>
                `;
            });
            
            // 添加总结
            const alignedCount = allResults.filter(r => r.aligned).length;
            const totalCount = allResults.length;
            
            html += `
                <div class="calculation">
                    <h4>总结</h4>
                    对齐成功: ${alignedCount}/${totalCount}<br>
                    对齐率: ${((alignedCount/totalCount)*100).toFixed(1)}%<br><br>
                    
                    <strong>计算公式验证:</strong><br>
                    桌面端: top = (时间分钟 - 420) × 0.8<br>
                    移动端: top = (时间分钟 - 420) × ${(40/60).toFixed(3)}<br><br>
                    
                    <strong>期望公式:</strong><br>
                    桌面端: top = 时间槽索引 × 48px<br>
                    移动端: top = 时间槽索引 × 40px
                </div>
            `;
            
            resultsContainer.innerHTML = html;
        }
        
        displayResults();
        
        // 添加实时窗口大小检测
        function checkWindowSize() {
            const info = document.createElement('div');
            info.className = 'info';
            info.innerHTML = `
                <h4>当前窗口信息</h4>
                窗口宽度: ${window.innerWidth}px<br>
                是否移动端: ${window.innerWidth <= 768 ? '是' : '否'}<br>
                应使用PIXEL_PER_MIN: ${window.innerWidth <= 768 ? (40/60).toFixed(3) : '0.8'}
            `;
            document.body.appendChild(info);
        }
        
        checkWindowSize();
        
        window.addEventListener('resize', () => {
            // 清除旧的窗口信息
            const oldInfo = document.querySelector('.info:last-child');
            if (oldInfo && oldInfo.innerHTML.includes('当前窗口信息')) {
                oldInfo.remove();
            }
            checkWindowSize();
        });
    </script>
</body>
</html>